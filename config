-- Bootstrap lazy.nvim
local lazypath = vim.fn.stdpath("data") .. "/lazy/lazy.nvim"
if not vim.loop.fs_stat(lazypath) then
  vim.fn.system({
    "git",
    "clone",
    "--filter=blob:none",
    "https://github.com/folke/lazy.nvim.git",
    "--branch=stable",
    lazypath,
  })
end
vim.opt.rtp:prepend(lazypath)

-- Setup plugins
require("lazy").setup({
  {
    "nvim-treesitter/nvim-treesitter",
    build = ":TSUpdate",
    config = function()
      require("nvim-treesitter.configs").setup({
        ensure_installed = { "lua", "vim", "vimdoc" },
        highlight = { enable = true },
      })
    end,
  },
})

-- Basic Settings
vim.opt.compatible = false        -- Be iMproved, required
vim.cmd('filetype off')          -- Required for plugin management
vim.cmd('syntax on')             -- Enable syntax highlighting
vim.opt.number = true            -- Show line numbers
vim.opt.relativenumber = true    -- Show relative line numbers for easy movement
vim.opt.ruler = true             -- Show cursor position
vim.opt.showcmd = true           -- Show incomplete commands
vim.opt.wildmenu = true          -- Enhanced command-line completion
vim.opt.encoding = 'utf8'        -- Set UTF-8 encoding
vim.opt.fileencoding = 'utf8'    -- Set UTF-8 file encoding

-- Indentation Settings
vim.opt.autoindent = true
vim.opt.shiftwidth = 2
vim.opt.tabstop = 2
vim.opt.expandtab = true
vim.opt.softtabstop = 2
vim.opt.smartindent = true
vim.opt.smarttab = true

-- Search Settings
vim.opt.incsearch = true         -- Search as characters are entered
vim.opt.hlsearch = true          -- Highlight matches
vim.opt.ignorecase = true        -- Ignore case when searching
vim.opt.smartcase = true         -- Override ignorecase if search pattern has upper case

-- Visual Settings
vim.opt.cursorline = true        -- Highlight current line
vim.opt.cursorcolumn = true      -- Highlight current column
vim.opt.showmatch = true         -- Highlight matching [{()}]
vim.opt.colorcolumn = '80'       -- Show column at 80 characters
vim.opt.laststatus = 2           -- Always show status line
vim.opt.list = true              -- Show invisible characters
vim.opt.listchars = {
  tab = '→ ',
  space = '·',
  nbsp = '␣',
  trail = '•',
  precedes = '«',
  extends = '»'
}

-- Trailing Space Highlighting
vim.cmd([[
  highlight ExtraWhitespace ctermbg=red guibg=red
  match ExtraWhitespace /\s\+$/
]])

vim.api.nvim_create_autocmd({"BufWinEnter"}, {
  pattern = "*",
  command = "match ExtraWhitespace /\\s\\+$/"
})

vim.api.nvim_create_autocmd({"InsertEnter"}, {
  pattern = "*",
  command = "match ExtraWhitespace /\\s\\+\\%#\\@<!$/"
})

vim.api.nvim_create_autocmd({"InsertLeave"}, {
  pattern = "*",
  command = "match ExtraWhitespace /\\s\\+$/"
})

vim.api.nvim_create_autocmd({"BufWinLeave"}, {
  pattern = "*",
  command = "call clearmatches()"
})

-- Functionality
vim.opt.backspace = {'indent', 'eol', 'start'}  -- Make backspace work as expected
vim.opt.hidden = true                           -- Allow hidden buffers
vim.opt.history = 1000                          -- Store more history
vim.opt.undolevels = 1000                       -- More undo levels
vim.opt.wildignore = {'*.swp', '*.bak', '*.pyc', '*.class'}
vim.opt.title = true                            -- Change the terminal's title
vim.opt.visualbell = true                       -- Don't beep
vim.opt.errorbells = false                      -- Don't beep

-- Color scheme settings
vim.opt.background = 'dark'
if vim.fn.has('termguicolors') == 1 then
  vim.opt.termguicolors = true
end

-- Nix-specific indentation settings
vim.api.nvim_create_autocmd("FileType", {
  pattern = "nix",
  callback = function()
    vim.opt_local.shiftwidth = 2
    vim.opt_local.tabstop = 2
    vim.opt_local.softtabstop = 2
    vim.opt_local.expandtab = true
    vim.opt_local.indentkeys:remove("0#")
    vim.opt_local.cindent = true
    vim.opt_local.cinoptions = "l1,t0,(0,W2s"
  end
})
